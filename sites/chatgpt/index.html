<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CloudPulse ‚Äî –ü–æ–≥–æ–¥–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<meta name="description" content="CloudPulse ‚Äî –∫—Ä–∞—Å–∏–≤–æ–µ —Ç—ë–º–Ω–æ–µ –ø–æ–≥–æ–¥–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≥–Ω–æ–∑, —á–∞—Å—ã, –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è."/>
<style>
  /* ====== BASE & THEME ====== */
  :root{
    --bg:#071021;
    --card:#0c1724;
    --muted:#98a1b3;
    --accent:#6EE7B7;
    --accent-2:#7dd3fc;
    --glass: rgba(255,255,255,0.02);
    --glass-2: rgba(255,255,255,0.03);
    --glass-3: rgba(255,255,255,0.015);
    --danger:#ff6b6b;
    --radius:14px;
    --shadow: 0 6px 25px rgba(2,6,23,0.6);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 400px at 10% 10%, rgba(125,211,252,0.06), transparent 10%),
      radial-gradient(700px 300px at 90% 90%, rgba(110,231,183,0.03), transparent 10%),
      linear-gradient(180deg,var(--bg), #03101a 120%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:32px;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    gap:24px;
    min-height:100vh;
  }

  /* Container */
  .app{
    width:100%;
    max-width:1200px;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:22px;
    align-items:start;
  }

  /* Left column: search & current */
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:var(--shadow);
    border: 1px solid rgba(255,255,255,0.03);
  }

  header.app-header{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:46px;height:46px;border-radius:10px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:grid;place-items:center;font-weight:700;color:#042127;
    box-shadow: 0 6px 18px rgba(125,211,252,0.08), inset 0 -6px 20px rgba(255,255,255,0.06);
  }
  .brand h1{font-size:16px;margin:0}
  .brand p{font-size:12px;margin:0;color:var(--muted)}

  .controls{display:flex;gap:8px;align-items:center}
  .btn{
    background:var(--glass);
    border:1px solid rgba(255,255,255,0.03);
    padding:8px 12px;border-radius:10px;color:var(--muted);
    cursor:pointer;font-size:13px;
  }
  .btn.primary{
    background:linear-gradient(90deg, rgba(125,211,252,0.06), rgba(110,231,183,0.04));
    color:var(--accent-2);
    font-weight:600;
  }

  /* Search */
  .search{
    display:flex;
    gap:8px;
    align-items:center;
    margin-bottom:12px;
  }
  .search input{
    flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
    background:transparent;color:inherit;font-size:15px;outline:none;
    box-shadow: inset 0 -6px 18px rgba(0,0,0,0.25);
  }
  .search .icon{opacity:0.8}
  .suggestions{
    margin-top:8px;
    background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
    border-radius:10px;padding:6px;border:1px solid rgba(255,255,255,0.02);
    backdrop-filter: blur(6px);
    max-height:220px;overflow:auto;
  }
  .suggestion{
    padding:8px 10px;border-radius:8px;cursor:pointer;font-size:14px;color:var(--muted);
  }
  .suggestion:hover{background:rgba(255,255,255,0.02);color:var(--accent-2)}

  /* Current weather card */
  .current{
    display:flex;gap:12px;align-items:center;
  }
  .current .left{
    flex:1;
  }
  .current .temp{
    font-size:52px;font-weight:700;
    line-height:1;color:var(--accent);
  }
  .current .meta{color:var(--muted);margin-top:6px;font-size:14px}
  .weather-icon{
    width:120px;height:120px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);
  }

  .details{
    display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;
  }
  .detail{
    background:var(--glass-2);padding:10px;border-radius:10px;font-size:13px;color:var(--muted);
    min-width:110px;text-align:center;
  }

  /* Right column */
  .main{
    display:flex;flex-direction:column;gap:18px;
  }

  .panel.large{
    padding:18px;
    min-height:150px;
  }

  /* Hourly strip */
  .hourly{
    display:flex;flex-direction:column;
  }
  .hourly .strip{
    display:flex;gap:12px;overflow:auto;padding:10px 4px;margin-top:8px;
  }
  .hour-card{
    min-width:96px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.02);
  }
  .hour-card strong{display:block;font-size:16px;margin-bottom:4px}

  /* Daily grid */
  .days{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:8px;
  }
  .day-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
    border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);
  }

  /* extras */
  .extras{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .stat{flex:1;min-width:140px;padding:12px;border-radius:12px;background:var(--glass-3);border:1px solid rgba(255,255,255,0.02);}

  footer.app-footer{margin-top:10px;color:var(--muted);font-size:13px;text-align:center}

  /* Loading skeleton */
  .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border-radius:8px; height:14px; width:100%; animation: shimmer 1.6s linear infinite;}
  @keyframes shimmer {0%{background-position:-200px 0}100%{background-position:200px 0}}

  /* Responsive */
  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding-bottom:60px}
    body{padding:18px}
    .logo{width:40px;height:40px}
    .current .temp{font-size:44px}
    .weather-icon{width:96px;height:96px}
  }

  /* small niceties */
  .muted{color:var(--muted)}
  .big{font-size:18px;font-weight:600}
  .tiny{font-size:12px;color:var(--muted)}
  a.link{color:var(--accent-2);text-decoration:none}
  .toggle{display:inline-flex;align-items:center;gap:8px;background:var(--glass);padding:6px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
</style>
</head>
<body>
  <div class="app" id="app">
    <!-- LEFT COLUMN -->
    <div class="panel">
      <header class="app-header">
        <div class="brand">
          <div class="logo">CP</div>
          <div>
            <h1>CloudPulse</h1>
            <p>–¢–æ—á–Ω–∞—è –ø–æ–≥–æ–¥–∞. –¢—ë–º–Ω–∞—è —Ç–µ–º–∞.</p>
          </div>
        </div>
        <div class="controls">
          <div class="toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –µ–¥–∏–Ω–∏—Ü—ã">
            <label id="unit-label">¬∞C</label>
            <button class="btn" id="toggle-unit" aria-label="toggle units">‚áÑ</button>
          </div>
          <button class="btn" id="locate" title="–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">üìç</button>
        </div>
      </header>

      <div class="search" role="search">
        <input id="search-input" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ –ø–æ—á—Ç–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Amsterdam, 1012)" autocomplete="off" aria-label="search city" />
        <button class="btn primary" id="search-btn">–ü–æ–∏—Å–∫</button>
      </div>
      <div id="suggestions" class="suggestions" hidden></div>

      <div style="height:12px"></div>

      <div id="currentCard" class="current" aria-live="polite">
        <div class="left">
          <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
            <div>
              <div class="temp" id="temp">--¬∞</div>
              <div class="meta" id="loc">‚Äî</div>
            </div>
            <div class="tiny muted" id="last-updated">–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>
          </div>

          <div id="cond-text" class="muted" style="margin-top:8px">‚Äî</div>

          <div class="details" id="details" aria-hidden="false">
            <div class="detail">–í–µ—Ç–µ—Ä: ‚Äî</div>
            <div class="detail">–í–ª–∞–∂–Ω–æ—Å—Ç—å: ‚Äî</div>
            <div class="detail">–î–∞–≤–ª–µ–Ω–∏–µ: ‚Äî</div>
            <div class="detail">–û–±–ª–∞—á–Ω–æ—Å—Ç—å: ‚Äî</div>
          </div>
        </div>

        <div class="weather-icon" id="icon-wrap">
          <!-- svg or img -->
          <img id="cond-icon" src="" alt="" style="width:84px;height:84px">
        </div>
      </div>

      <div style="height:14px"></div>
      <div class="panel" style="padding:10px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="tiny muted">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å:</div>
          <div id="last-city" class="big">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn" id="download-json" title="–°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–≥–æ–¥—ã">‚¨áÔ∏è JSON</button>
        </div>
      </div>

      <footer class="app-footer">
        <div>–î–∞–Ω–Ω—ã–µ: WeatherAPI.com ¬∑ –ö–ª—é—á: <span id="api-key-short" class="muted"></span></div>
      </footer>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="main">
      <div class="panel large">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 style="margin:0">–ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑</h2>
          <div class="tiny muted">Source: WeatherAPI</div>
        </div>

        <div id="hourly" class="hourly">
          <div class="strip" id="hourly-strip" aria-live="polite">
            <!-- hour cards -->
          </div>
        </div>

        <div style="height:12px"></div>

        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3 style="margin:0">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–Ω–∏</h3>
          <div class="tiny muted">7 –¥–Ω–µ–π (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)</div>
        </div>

        <div id="days" class="days"></div>
      </div>

      <div class="panel">
        <h3 style="margin-top:0">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</h3>
        <div class="extras" id="extras" aria-live="polite">
          <div class="stat">–í–æ—Å—Ö–æ–¥: ‚Äî<div class="tiny muted">–≤—Ä–µ–º—è</div></div>
          <div class="stat">–ó–∞—Ö–æ–¥: ‚Äî<div class="tiny muted">–≤—Ä–µ–º—è</div></div>
          <div class="stat">UV: ‚Äî<div class="tiny muted">–∏–Ω–¥–µ–∫—Å</div></div>
          <div class="stat">–û—Å–∞–¥–∫–∏: ‚Äî<div class="tiny muted">–º–º</div></div>
        </div>
        <div style="height:10px"></div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="toggle-precip">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–∞–¥–∫–∏ (–≥—Ä–∞—Ñ–∏–∫)</button>
          <button class="btn" id="toggle-wind">–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ç–µ—Ä (–≥—Ä–∞—Ñ–∏–∫)</button>
          <a class="btn" id="about" href="#" onclick="event.preventDefault(); alert('CloudPulse ‚Äî –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç.');">‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</a>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
(function(){
  'use strict';

  const API_KEY = 'b3c49a30ffe144edb72135917250409';
  const BASE = 'https://api.weatherapi.com/v1';
  const DEFAULT_CITY = 'Moscow';
  const REQUESTED_DAYS = 7; // –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å 7, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç –º–µ–Ω—å—à–µ ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å
  const CACHE_TTL_MS = 1000 * 60 * 10; // 10 –º–∏–Ω—É—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)

  const appState = {
    unit: localStorage.getItem('cp_unit') || 'C', // 'C' or 'F'
    lastCity: localStorage.getItem('cp_lastCity') || '',
    lastResponse: null,
    lastFetchedAt: localStorage.getItem('cp_lastFetchedAt') ? Number(localStorage.getItem('cp_lastFetchedAt')) : 0
  };

  /* ======= Helpers ======= */
  function $(id){ return document.getElementById(id); }
  function formatTemp(tC){
    if (tC === null || tC === undefined) return '‚Äî';
    return appState.unit === 'C' ? Math.round(tC) + '¬∞C' : Math.round(tC * 9/5 +32) + '¬∞F';
  }
  function formatTimeLocal(dtStr){
    try {
      // dtStr like "2025-11-22 18:00"
      const d = new Date(dtStr.replace(' ', 'T'));
      if (isNaN(d)) return dtStr;
      return d.toLocaleTimeString(undefined, {hour:'2-digit',minute:'2-digit'});
    } catch (e) {
      return dtStr;
    }
  }
  function friendlyDate(dtStr){
    try {
      const date = new Date(dtStr);
      if (isNaN(date)) return dtStr;
      return date.toLocaleDateString(undefined, {weekday:'short', day:'numeric', month:'short'});
    } catch (e) {
      return dtStr;
    }
  }
  function shortKey(k){ return typeof k === 'string' && k.length > 8 ? k.slice(0,6)+'‚Ä¶' : k; }

  // safe getter for nested props
  function safe(obj, path, fallback) {
    try {
      return path.split('.').reduce((s,p)=> (s && s[p] !== undefined) ? s[p] : undefined, obj) ?? fallback;
    } catch (e) { return fallback; }
  }

  /* ======= UI references ======= */
  const searchInput = $('search-input');
  const searchBtn = $('search-btn');
  const suggestionsWrap = $('suggestions');
  const locateBtn = $('locate');
  const toggleUnitBtn = $('toggle-unit');
  const unitLabel = $('unit-label');
  const tempEl = $('temp');
  const locEl = $('loc');
  const condText = $('cond-text');
  const condIcon = $('cond-icon');
  const lastUpdated = $('last-updated');
  const lastCityEl = $('last-city');
  const hourlyStrip = $('hourly-strip');
  const daysWrap = $('days');
  const detailsEl = $('details');
  const extrasEl = $('extras');
  const refreshBtn = $('refresh');
  const downloadBtn = $('download-json');
  const apiKeyShortSpan = $('api-key-short');

  if (apiKeyShortSpan) apiKeyShortSpan.textContent = shortKey(API_KEY);

  /* ======= Init ======= */
  unitLabel.textContent = '¬∞' + appState.unit;
  if (appState.lastCity) lastCityEl.textContent = appState.lastCity;

  /* ======= Simple caching layer (localStorage) ======= */
  function saveCache(city, data) {
    try {
      localStorage.setItem('cp_cache_' + city, JSON.stringify({ ts: Date.now(), data }));
      localStorage.setItem('cp_lastCity', city);
      localStorage.setItem('cp_lastFetchedAt', String(Date.now()));
      appState.lastCity = city;
      appState.lastFetchedAt = Date.now();
    } catch (e) { /* ignore storage write errors */ }
  }
  function loadCache(city) {
    try {
      const raw = localStorage.getItem('cp_cache_' + city);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed || !parsed.ts || !parsed.data) return null;
      if (Date.now() - parsed.ts > CACHE_TTL_MS) return null;
      return parsed.data;
    } catch (e) { return null; }
  }

  /* ======= API CALLS ======= */
  async function fetchWeather(q){
    const safeQ = typeof q === 'string' ? q : String(q);
    const url = `${BASE}/forecast.json?key=${API_KEY}&q=${encodeURIComponent(safeQ)}&days=${REQUESTED_DAYS}&aqi=yes&alerts=yes&lang=ru`;
    const res = await fetch(url);
    if (!res.ok) {
      const txt = await res.text().catch(()=>(''));
      throw new Error('API Error: ' + res.status + ' ‚Äî ' + (txt || res.statusText));
    }
    const json = await res.json();
    // basic validation
    if (!json || !json.location) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç API');
    return json;
  }

  async function fetchSearch(q){
    const url = `${BASE}/search.json?key=${API_KEY}&q=${encodeURIComponent(q)}&lang=ru`;
    const res = await fetch(url);
    if (!res.ok) return [];
    const json = await res.json();
    if (!Array.isArray(json)) return [];
    return json;
  }

  /* ======= Rendering ======= */
  function renderCurrent(data){
    if (!data) return;
    const locName = `${safe(data, 'location.name', '')}${safe(data, 'location.region', '') ? ', ' + safe(data, 'location.region') : ''}${safe(data, 'location.country') ? ', ' + safe(data, 'location.country') : ''}`;
    lastCityEl.textContent = locName || '‚Äî';
    tempEl.textContent = formatTemp(safe(data, 'current.temp_c', null));
    locEl.textContent = `${locName} ¬∑ ${safe(data, 'location.localtime', '')}`;
    condText.textContent = safe(data, 'current.condition.text', '‚Äî');
    const iconUrl = safe(data, 'current.condition.icon', '');
    if (iconUrl) {
      condIcon.src = iconUrl.startsWith('http') ? iconUrl : ('https:' + iconUrl);
      condIcon.alt = safe(data, 'current.condition.text', '');
      condIcon.style.display = '';
    } else {
      condIcon.style.display = 'none';
    }
    const lastUpdatedText = safe(data, 'current.last_updated', '');
    lastUpdated.textContent = lastUpdatedText ? ('–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date(lastUpdatedText.replace(' ', 'T')).toLocaleString()) : '–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî';

    // details
    const wind = `${safe(data, 'current.wind_kph', '‚Äî')} km/h (dir ${safe(data, 'current.wind_dir', '‚Äî')})`;
    const hum = (safe(data, 'current.humidity', '‚Äî') !== '‚Äî') ? (safe(data, 'current.humidity') + '%') : '‚Äî';
    const pres = (safe(data, 'current.pressure_mb', '‚Äî') !== '‚Äî') ? (safe(data, 'current.pressure_mb') + ' mb') : '‚Äî';
    const cloud = (safe(data, 'current.cloud', '‚Äî') !== '‚Äî') ? (safe(data, 'current.cloud') + '%') : '‚Äî';

    detailsEl.innerHTML = `
      <div class="detail">–í–µ—Ç–µ—Ä:<br><strong>${wind}</strong></div>
      <div class="detail">–í–ª–∞–∂–Ω–æ—Å—Ç—å:<br><strong>${hum}</strong></div>
      <div class="detail">–î–∞–≤–ª–µ–Ω–∏–µ:<br><strong>${pres}</strong></div>
      <div class="detail">–û–±–ª–∞—á–Ω–æ—Å—Ç—å:<br><strong>${cloud}</strong></div>
    `;

    // extras (astro may be missing)
    const astro = safe(data, 'forecast.forecastday.0.astro', null);
    const precip_mm = safe(data, 'current.precip_mm', '‚Äî');
    extrasEl.innerHTML = `
      <div class="stat">–í–æ—Å—Ö–æ–¥: <div class="tiny muted">${astro ? astro.sunrise : '‚Äî'}</div></div>
      <div class="stat">–ó–∞—Ö–æ–¥: <div class="tiny muted">${astro ? astro.sunset : '‚Äî'}</div></div>
      <div class="stat">UV: <div class="tiny muted">${safe(data, 'current.uv', '‚Äî')}</div></div>
      <div class="stat">–û—Å–∞–¥–∫–∏: <div class="tiny muted">${precip_mm} –º–º</div></div>
    `;
  }

  function renderHourly(data){
    hourlyStrip.innerHTML = '';
    if (!data || !data.forecast || !Array.isArray(data.forecast.forecastday)) return;
    // merge hours
    const hours = data.forecast.forecastday.reduce((acc, fd) => {
      if (Array.isArray(fd.hour)) acc.push(...fd.hour);
      return acc;
    }, []);
    // pick next 24 hours relative to localtime of location if possible
    const nextHours = hours.slice(0, 24);
    nextHours.forEach(h => {
      const col = document.createElement('div');
      col.className = 'hour-card';
      const time = formatTimeLocal(safe(h, 'time', ''));
      const icon = safe(h, 'condition.icon', '') ? (safe(h, 'condition.icon').startsWith('http') ? safe(h, 'condition.icon') : ('https:' + safe(h, 'condition.icon'))) : '';
      const temp = formatTemp(safe(h, 'temp_c', null));
      const text = safe(h, 'condition.text', '‚Äî');
      const chance = safe(h, 'chance_of_rain', safe(h, 'will_it_rain', '‚Äî'));
      const wind = safe(h, 'wind_kph', '‚Äî');
      col.innerHTML = `
        <strong>${time}</strong>
        ${icon ? `<img src="${icon}" alt="${text}" style="width:44px;height:44px;margin:6px 0">` : ''}
        <div style="font-weight:600">${temp}</div>
        <div class="tiny muted">${text}</div>
        <div class="tiny muted" style="margin-top:6px">üåß ${chance}% ¬∑ üí® ${wind} km/h</div>
      `;
      hourlyStrip.appendChild(col);
    });
  }

  function renderDays(data){
    daysWrap.innerHTML = '';
    if (!data || !data.forecast || !Array.isArray(data.forecast.forecastday)) return;
    const days = data.forecast.forecastday || [];
    days.forEach(d => {
      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      const dateFriendly = friendlyDate(safe(d, 'date', ''));
      const icon = safe(d, 'day.condition.icon', '') ? (safe(d, 'day.condition.icon').startsWith('http') ? safe(d, 'day.condition.icon') : ('https:' + safe(d, 'day.condition.icon'))) : '';
      const maxt = formatTemp(safe(d, 'day.maxtemp_c', null));
      const mint = formatTemp(safe(d, 'day.mintemp_c', null));
      const precipitation = safe(d, 'day.totalprecip_mm', '‚Äî');
      const conditionText = safe(d, 'day.condition.text', '‚Äî');
      dayCard.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${dateFriendly}</strong><div class="tiny muted">${safe(d, 'date','')}</div></div>
          ${icon ? `<img src="${icon}" alt="${conditionText}" style="width:48px;height:48px">` : ''}
        </div>
        <div style="margin-top:8px;font-weight:600">${conditionText}</div>
        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <div class="tiny muted">–ú–∞–∫—Å</div><div>${maxt}</div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <div class="tiny muted">–ú–∏–Ω</div><div>${mint}</div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:10px">
          <div class="tiny muted">–û—Å–∞–¥–∫–∏</div><div>${precipitation} –º–º</div>
        </div>
      `;
      daysWrap.appendChild(dayCard);
    });
  }

  /* ======= Main flow ======= */
  async function loadWeatherFor(q, opts = { save: true, forceFetch: false }) {
    if (!q) return;
    showLoading();

    // try cache first if not forced
    const cacheCandidate = !opts.forceFetch ? loadCache(q) : null;
    if (cacheCandidate) {
      try {
        appState.lastResponse = cacheCandidate;
        renderCurrent(cacheCandidate);
        renderHourly(cacheCandidate);
        renderDays(cacheCandidate);
        hideSuggestions();
        hideLoading();
        return;
      } catch (e) {
        // fallthrough to fetch
        console.warn('cache render failed', e);
      }
    }

    try {
      const data = await fetchWeather(q);
      // if server returns less days than requested, it's ok ‚Äî we'll render what we have
      appState.lastResponse = data;
      renderCurrent(data);
      renderHourly(data);
      renderDays(data);

      if (opts.save) {
        try {
          const cityLabel = `${safe(data, 'location.name', '')}${safe(data, 'location.country') ? ', ' + safe(data, 'location.country') : ''}`;
          saveCache(cityLabel, data);
          lastCityEl.textContent = cityLabel;
        } catch (e) { /* ignore */ }
      }
      hideSuggestions();
    } catch (e) {
      console.error('loadWeatherFor error', e);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–≥–æ–¥—É: ' + (e && e.message ? e.message : String(e)));
    } finally {
      hideLoading();
    }
  }

  function showLoading(){
    if (tempEl) tempEl.textContent = '‚Äî¬∞';
    if (condText) condText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
  }
  function hideLoading(){ /* nothing specific - data replace UI */ }

  /* ======= Events ======= */
  let searchDebounceTimer = null;
  if (searchInput) {
    searchInput.addEventListener('input', async (e) => {
      const q = e.target.value.trim();
      clearTimeout(searchDebounceTimer);
      if (!q) {
        hideSuggestions(); return;
      }
      searchDebounceTimer = setTimeout(async () => {
        try {
          const res = await fetchSearch(q);
          if (!res || res.length === 0){ hideSuggestions(); return; }
          showSuggestions(res);
        } catch (err) {
          console.warn('search err', err);
          hideSuggestions();
        }
      }, 300);
    });

    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') searchBtn && searchBtn.click();
    });
  }

  function showSuggestions(list){
    if (!suggestionsWrap) return;
    suggestionsWrap.innerHTML = '';
    const toShow = Array.isArray(list) ? list.slice(0, 10) : [];
    toShow.forEach(item => {
      const el = document.createElement('div');
      el.className = 'suggestion';
      // Some search results from weatherapi have name+region+country or fields like url.
      const region = item.region || item.country || '';
      el.textContent = `${item.name}${region ? ', ' + region : ''}`;
      el.onclick = () => {
        // Prefer coordinates url if provided (WeatherAPI returns url like "/q/zmw:..."), but simpler to use name
        searchInput.value = item.name || '';
        hideSuggestions();
        // load by name ‚Äî safe
        loadWeatherFor(item.name || item.url || item.query || item.name);
      };
      suggestionsWrap.appendChild(el);
    });
    suggestionsWrap.hidden = false;
  }

  function hideSuggestions(){ if (suggestionsWrap) { suggestionsWrap.hidden = true; suggestionsWrap.innerHTML = ''; } }

  if (searchBtn) {
    searchBtn.addEventListener('click', () => {
      const q = searchInput.value.trim();
      if (!q){
        alert('–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å');
        return;
      }
      loadWeatherFor(q);
    });
  }

  if (locateBtn) {
    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation){
        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.');
        return;
      }
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        loadWeatherFor(`${lat},${lon}`);
      }, err => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + (err && err.message ? err.message : String(err)));
      }, {enableHighAccuracy:true, timeout:10000});
    });
  }

  if (toggleUnitBtn) {
    toggleUnitBtn.addEventListener('click', () => {
      appState.unit = appState.unit === 'C' ? 'F' : 'C';
      unitLabel.textContent = '¬∞' + appState.unit;
      localStorage.setItem('cp_unit', appState.unit);
      // re-render last response if exists
      if (appState.lastResponse){
        renderCurrent(appState.lastResponse);
        renderHourly(appState.lastResponse);
        renderDays(appState.lastResponse);
      }
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      const last = appState.lastCity || searchInput.value.trim() || DEFAULT_CITY;
      loadWeatherFor(last, {save:true, forceFetch:true});
    });
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      if (!appState.lastResponse){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'); return; }
      try {
        const blob = new Blob([JSON.stringify(appState.lastResponse, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'weather.json';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: ' + (e && e.message ? e.message : String(e)));
      }
    });
  }

  /* ======= Keyboard shortcuts (nice UX) ======= */
  document.addEventListener('keydown', e => {
    if (e.key === 'k' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); searchInput.focus(); searchInput.select(); }
  });

  /* ======= Small animations: background parallax on mouse ======= */
  document.addEventListener('mousemove', e => {
    const x = (e.clientX / window.innerWidth - 0.5) * 20;
    const y = (e.clientY / window.innerHeight - 0.5) * 20;
    // keep as percentage string
    document.body.style.backgroundPosition = `${50 - x}% ${50 - y}%`;
  });

  /* ======= On load: try to restore or geolocate ======= */
  async function start(){
    // prefer cached lastCity if still valid
    if (appState.lastCity) {
      const cached = loadCache(appState.lastCity);
      if (cached) {
        try {
          appState.lastResponse = cached;
          renderCurrent(cached);
          renderHourly(cached);
          renderDays(cached);
        } catch (e) {
          console.warn('cached render fail', e);
        }
      } else {
        // try to fetch fresh
        try {
          await loadWeatherFor(appState.lastCity, {save:true, forceFetch:false});
          return;
        } catch (e) {
          console.warn('restore lastCity failed', e);
        }
      }
    }

    // try geolocation silently (no prompt fallbacks)
    if (navigator.geolocation){
      let geoTimedOut = false;
      const geoPromise = new Promise((resolve) => {
        const onSuccess = async (pos) => {
          try { await loadWeatherFor(`${pos.coords.latitude},${pos.coords.longitude}`, {save:true}); } catch (e) { console.warn(e); }
          resolve();
        };
        const onFail = async () => {
          resolve();
        };
        try {
          navigator.geolocation.getCurrentPosition(onSuccess, onFail, {timeout:6000});
        } catch (e) {
          resolve();
        }
      });
      // Wait short while, then if nothing, fallback
      await geoPromise;
      // If no data loaded yet, fallback:
      if (!appState.lastResponse) {
        await loadWeatherFor(DEFAULT_CITY, {save:true});
      }
    } else {
      await loadWeatherFor(DEFAULT_CITY, {save:true});
    }
  }

  start();

  /* ======= Extra: toggles that show simple charts (built-in canvas) ======= */
  const togglePrecipBtn = $('toggle-precip');
  const toggleWindBtn = $('toggle-wind');

  if (togglePrecipBtn) {
    togglePrecipBtn.addEventListener('click', () => {
      if (!appState.lastResponse){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞.'); return; }
      showSimpleChart(appState.lastResponse, 'precip_mm', '–û—Å–∞–¥–∫–∏ (–º–º)');
    });
  }
  if (toggleWindBtn) {
    toggleWindBtn.addEventListener('click', () => {
      if (!appState.lastResponse){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞.'); return; }
      showSimpleChart(appState.lastResponse, 'wind_kph', '–í–µ—Ç–µ—Ä (–∫–º/—á)');
    });
  }

  function showSimpleChart(data, key, label){
    try {
      const hours = (safe(data, 'forecast.forecastday', []).flatMap(fd => Array.isArray(fd.hour) ? fd.hour : [])).slice(0,24);
      const values = hours.map(h => (h && h[key] !== undefined) ? Number(h[key]) : 0);
      const labels = hours.map(h => formatTimeLocal(safe(h,'time','')));

      // create modal
      const existing = document.getElementById('cp_modal_chart');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.id = 'cp_modal_chart';
      modal.style.position='fixed';
      modal.style.inset='0';
      modal.style.background='rgba(2,6,12,0.6)';
      modal.style.display='grid';
      modal.style.placeItems='center';
      modal.style.zIndex=9999;

      const card = document.createElement('div');
      card.style.width='min(880px,96%)';
      card.style.maxWidth='980px';
      card.style.background='var(--card)';
      card.style.borderRadius='14px';
      card.style.padding='18px';
      card.style.border='1px solid rgba(255,255,255,0.03)';
      card.style.boxSizing='border-box';
      card.style.boxShadow = 'var(--shadow)';

      const title = document.createElement('div');
      title.innerHTML = `<strong>${label}</strong><div class="tiny muted">24 —á–∞—Å–∞</div>`;

      const canvas = document.createElement('canvas');
      canvas.width = 900;
      canvas.height = 340;
      canvas.style.width = '100%';
      canvas.style.marginTop = '10px';
      canvas.style.background = 'transparent';
      canvas.style.borderRadius = '8px';

      const close = document.createElement('button');
      close.className = 'btn';
      close.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
      close.style.marginTop = '12px';
      close.addEventListener('click', () => modal.remove());

      card.appendChild(title);
      card.appendChild(canvas);
      card.appendChild(close);
      modal.appendChild(card);
      document.body.appendChild(modal);

      // canvas drawing
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const padding = 48;
      const w = canvas.width - padding*2;
      const h = canvas.height - padding*2;
      const max = Math.max(...values) || 1;
      const min = Math.min(...values);
      // grid
      ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth=1;
      for (let i=0;i<=4;i++){
        const y = padding + (h/4)*i;
        ctx.beginPath(); ctx.moveTo(padding,y); ctx.lineTo(padding+w,y); ctx.stroke();
      }
      // polyline
      ctx.beginPath();
      values.forEach((v,i)=>{
        const x = padding + (i/(Math.max(1, values.length-1)))*w;
        const y = padding + h - ((v - min)/( (max - min) || 1))*h;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.strokeStyle = 'rgba(125,211,252,0.95)'; ctx.lineWidth=2.6; ctx.stroke();
      // points
      values.forEach((v,i)=>{
        const x = padding + (i/(Math.max(1, values.length-1)))*w;
        const y = padding + h - ((v - min)/( (max - min) || 1))*h;
        ctx.fillStyle='rgba(125,211,252,0.95)'; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      });
      // labels (few)
      ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.font='12px Inter';
      const step = Math.max(1, Math.floor(values.length/6));
      for (let i=0;i<values.length;i+=step){
        const x = padding + (i/(Math.max(1, values.length-1)))*w;
        const txt = labels[i] || '';
        ctx.fillText(txt, Math.max(0, x-18), padding+h+18);
      }
      // left scale
      ctx.fillStyle='rgba(255,255,255,0.6)'; ctx.font='12px Inter';
      ctx.fillText((max).toFixed(0), 8, padding+6);
      ctx.fillText(((max+min)/2).toFixed(0), 8, padding + h/2);
      ctx.fillText((min).toFixed(0), 8, padding + h + 4);
    } catch (e) {
      console.error('showSimpleChart err', e);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + (e && e.message ? e.message : String(e)));
    }
  }

  /* ======= Extra accessibility: announce errors ======= */
  window.addEventListener('error', e => {
    console.error('Unhandled error', e);
  });

  // expose some helpers for debugging (dev only)
  window.cp = {
    loadWeatherFor,
    appState,
    fetchWeather,
    fetchSearch
  };

})();
</script>
</body>
</html>
